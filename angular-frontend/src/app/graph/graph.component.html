<svg #graphContainer 
     appResizeObserver 
     (resize)="updateGraphDimensions($event)" 
     appZoomable 
     [MINZOOM]="0.5"
     [MAXZOOM]="32" 
     [onlyXZoom]="zoomXOnly()" 
     [onlyYZoom]="zoomYOnly()" 
     [plotHost]="plot" 
     appGraphCursor 
     #cursor="appGraphCursor"
     [class.selection-mode]="selectionService.isSelectionMode()"
     (pointermove)="onPointerMove($event)" 
     (click)="survey.onGraphClick()"
     (pointerdown)="onPointerDown($event)"
     (pointerup)="onPointerUp($event)">
    
    <defs>
        <clipPath id="plotArea"> <!--PlotArea between the axis-->
            <rect [attr.width]="innerSize().w" [attr.height]="innerSize().h"></rect>
        </clipPath>
    </defs>
    <g #plot [attr.transform]="marginTransform()">
        <g #xAxis [attr.transform]="xAxisTransformString()" (pointerenter)="activateX()" (pointerleave)="deactivateZoom()">
            <rect class="axis" x="0" y="0" [attr.width] = "innerSize().w" [attr.height]="dataservice.margin.bottom" 
            fill="transparent" pointer-events="all"></rect> <!-- Hitbox for x-axis -->
        </g>
        <g #yAxis [attr.transform]="yAxisTransformString()" (pointerenter)="activateY()" (pointerleave)="deactivateZoom()">
            <rect class="axis" [attr.x]="-dataservice.margin.left" y="0" [attr.width] = "dataservice.margin.left" [attr.height]="innerSize().h" 
            fill="transparent" pointer-events="all"></rect> <!-- Hitbox for y-axis-->
        </g>

        <rect x="0" y="0" [attr.width]="innerSize().w" [attr.height]="innerSize().h" fill="transparent" 
        pointer-events="all" (pointerenter)="activateXY()" (pointerleave)="deactivateZoom()"></rect> <!-- Hitbox for plotarea-->
        
        <g [attr.clip-path]="'url(#plotArea)'" > <!-- Keep path in plotArea when zooming-->
            @for (path of dataservice.paths(); track $index) {
            <path [attr.d]="path.d" [attr.stroke]="path.stroke" fill="none" stroke-width="2" />
            }
        </g>
        
        <!-- Selection rectangle overlay -->
        @if (selectionService.selectionRect(); as rect) {
        <rect
          class="selection-rect"
          [attr.x]="rect.x - dataservice.margin.left"
          [attr.y]="rect.y"
          [attr.width]="rect.width"
          [attr.height]="rect.height"
        />
        }
        
        <!-- Survey markers -->
        @for (p of [survey.firstPoint(), survey.secondPoint()]; track $index) {
        @if (p) {
        <g class="marker" [attr.transform]="survey.markerTransform(p)">
            <line x1="-5" y1="0" x2="5" y2="0" stroke="red" />
            <line x1="0" y1="-30" x2="0" y2="30" stroke="red" />
        </g>
        }
        }
    </g>
</svg>

<!-- Selection toggle button as separate component -->
<app-selection-toggle></app-selection-toggle>

<!-- Selection results component -->
<app-selection-results></app-selection-results>

<!-- Cursor tooltip -->
@if (cursor.xValue() !== null && cursor.yValue() !== null) {
<div class="tooltip" [style.left.px]="mousePos.x + 12" [style.top.px]="mousePos.y + 12">
    X: {{ cursor.xValue() | date:'HH:mm:ss.SSS' }}<br>
    Y: {{ cursor.yValue() | number:'1.2-2' }}
</div>
}

<!-- Control buttons -->
<div class="button-wrapper">
    <app-graph-survey [cursor]="cursor" #survey></app-graph-survey>
    <mat-slide-toggle [checked]="xAxisTimeMode() === 'relative'" (change)="onXAxisTimeModeToggle($event.checked)">
        Relative Time
    </mat-slide-toggle>
</div>

<!-- Debug output (hidden by default) -->
<div style="display: none;">
    <h4>Debug Output</h4>

    <div>
        <strong>X Scale Domain:</strong>
        <pre>{{ dataservice.xScale().domain() | json }}</pre>
    </div>

    <div>
        <strong>X Scale Range:</strong>
        <pre>{{ dataservice.xScale().range() | json }}</pre>
    </div>

    <div>
        <strong>Y Scale Domain:</strong>
        <pre>{{ dataservice.yScale().domain() | json }}</pre>
    </div>

    <div>
        <strong>Y Scale Range:</strong>
        <pre>{{ dataservice.yScale().range() | json }}</pre>
    </div>

    <div>
        <strong>X Axis Transform:</strong>
        <pre>{{ xAxisTransformString() }}</pre>
    </div>

    <div>
        <strong>Y Axis Transform:</strong>
        <pre>{{ yAxisTransformString() }}</pre>
    </div>

    <div>
        <strong>Graph Dimensions:</strong>
        <pre>{{ dataservice.graphDimensions() | json }}</pre>
    </div>
</div>